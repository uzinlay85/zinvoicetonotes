<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZinNotes - Gemini AI Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', 'Padauk', sans-serif; }
        .pulse-red { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 25px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col h-screen overflow-hidden">

    <header class="bg-white shadow-md">
        <div class="max-w-4xl mx-auto py-3 px-4">
            <h1 class="text-2xl font-bold text-blue-600">ZinNotes</h1>
        </div>
    </header>

    <main class="flex-grow overflow-y-auto custom-scrollbar p-4 pb-24 max-w-4xl mx-auto w-full">
        <!-- Page 1: Home -->
        <div id="home-page" class="page flex flex-col items-center justify-center text-center h-full">
            <p class="text-lg text-gray-600 mb-4">မှတ်စုမှတ်ရန် အသံပီသစွာပြောပေးပါ</p>
            <div id="timer-display" class="text-2xl text-gray-800 font-mono mb-4 h-8"></div>
            <button id="mic-btn" class="w-32 h-32 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex items-center justify-center shadow-lg transition-all duration-200">
                <svg class="w-12 h-12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg>
            </button>
            <div id="live-transcription" class="mt-8 text-lg text-left text-gray-700 min-h-[50px] max-h-64 overflow-y-auto break-words w-full max-w-2xl bg-white p-4 rounded-lg shadow-md custom-scrollbar"></div>
        </div>

        <!-- Page 2: Notes -->
        <div id="notes-page" class="page hidden">
            <h2 class="text-2xl font-bold mb-4">Saved Notes</h2>
            <div id="notes-list" class="space-y-4"></div>
        </div>
        
        <!-- Page 3: History -->
        <div id="history-page" class="page hidden">
            <h2 class="text-2xl font-bold mb-2">Transcription History</h2>
            <p class="text-sm text-gray-500 mb-4">Unsaved transcriptions are kept for 24 hours.</p>
            <div id="history-list" class="space-y-3"></div>
        </div>

        <!-- Page 4: Settings -->
        <div id="settings-page" class="page hidden">
            <h2 class="text-2xl font-bold mb-4">Settings</h2>
            
            <!-- Gemini API Settings -->
            <div class="bg-white p-5 rounded-lg shadow-md mb-6">
                <h3 class="text-lg font-semibold border-b pb-2 mb-4">Gemini API Configuration</h3>
                <div>
                    <label for="gemini-api-key-input" class="block text-sm font-medium text-gray-700">Your Gemini API Key:</label>
                    <input type="password" id="gemini-api-key-input" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Enter your Gemini API Key">
                    <div class="flex justify-between items-center mt-3">
                        <p class="text-xs text-gray-500">API Key မရှိသေးပါက <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">AI Studio</a> တွင်ရယူပါ။</p>
                        <button id="save-gemini-key-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Save</button>
                    </div>
                </div>
            </div>

            <!-- Notion Integration Settings -->
            <div class="bg-white p-5 rounded-lg shadow-md mt-6">
                <h3 class="text-lg font-semibold border-b pb-2 mb-4">Notion Integration</h3>
                <p class="text-sm text-gray-600 mb-4">သင်၏မှတ်စုများကို သင်၏ကိုယ်ပိုင် Notion Database သို့ တိုက်ရိုက်သိမ်းဆည်းပါ။</p>
                
                <div class="space-y-4">
                    <div>
                        <label for="notion-api-key-input" class="block text-sm font-medium text-gray-700">Notion Integration Token (API Key):</label>
                        <input type="password" id="notion-api-key-input" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="secret_...">
                    </div>
                    <div>
                        <label for="notion-database-id-input" class="block text-sm font-medium text-gray-700">Notion Database ID:</label>
                        <input type="text" id="notion-database-id-input" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="a1b2c3d4...">
                    </div>
                </div>
                <div class="flex justify-end mt-4">
                    <button id="save-notion-settings-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Save Notion Settings</button>
                </div>

                <!-- How-to Guide -->
                <details class="mt-6 border-t pt-4">
                    <summary class="cursor-pointer text-blue-600 font-semibold hover:underline">
                        Notion Key နှင့် Database ID ရယူနည်း လမ်းညွှန်
                    </summary>
                    <div class="mt-4 text-sm text-gray-700 space-y-4 prose max-w-none">
                        <p>သင်၏ Notion Account နှင့်ချိတ်ဆက်ရန် အောက်ပါအဆင့်များကို တစ်ဆင့်ချင်းလုပ်ဆောင်ပါ။</p>
                        
                        <div>
                            <h4 class="font-bold">အဆင့် ၁: Notion Integration ပြုလုပ်ခြင်း (Token/Key ရယူရန်)</h4>
                            <ol class="list-decimal list-inside space-y-2">
                                <li><a href="https://www.notion.so/my-integrations" target="_blank" class="text-blue-600">Notion's My Integrations</a> စာမျက်နှာကို သွားပါ။</li>
                                <li><b>"+ New integration"</b> ခလုတ်ကိုနှိပ်ပြီး နာမည်တစ်ခုပေးပါ (ဥပမာ: "ZinNotes App")။</li>
                                <li>Submit လုပ်ပြီးနောက် ပေါ်လာသောစာမျက်နှာမှ <b>"Internal Integration Token"</b> ကို copy ကူးပါ။ ၎င်းသည်သင်၏ API Key ဖြစ်သည်။</li>
                                <li>ထို Key ကို အပေါ်က "Notion Integration Token" အကွက်တွင် ထည့်ပါ။</li>
                            </ol>
                        </div>

                        <div>
                            <h4 class="font-bold">အဆင့် ၂: Notion Database ပြုလုပ်ပြီး ID ရယူရန်</h4>
                             <ol class="list-decimal list-inside space-y-2">
                                <li>သင်၏ Notion Workspace တွင် Page အသစ်တစ်ခုဖွင့်ပြီး <b>Table - Full page</b> ကိုရွေးပါ။</li>
                                <li>Database ကို "ZinNotes" သို့မဟုတ် သင်ကြိုက်နှစ်သက်ရာ နာမည်ပေးပါ။ ပထမ column ၏နာမည်ကို <b>"Name"</b> ဟု သေချာစွာထားရှိပါ။</li>
                                <li>Browser ၏ address bar မှ URL ကို copy ကူးပါ။ ဥပမာ: <code>https://www.notion.so/your-workspace/<b>a1b2c3d4e5f61234567890abcdefghij</b>?v=...</code></li>
                                <li><code>/</code> နှင့် <code>?</code> ကြားရှိ စာလုံးအရှည်သည် သင်၏ <b>Database ID</b> ဖြစ်သည်။ ၎င်းကို copy ကူးပြီး အပေါ်က "Notion Database ID" အကွက်တွင် ထည့်ပါ။</li>
                            </ol>
                        </div>
                        
                        <div>
                           <h4 class="font-bold">အဆင့် ၃: Integration နှင့် Database ကိုချိတ်ဆက်ခြင်း</h4>
                           <ol class="list-decimal list-inside space-y-2">
                               <li>သင်ပြုလုပ်ထားသော Notion Database စာမျက်နှာ၏ ညာဘက်အပေါ်ထောင့်ရှိ အစက်သုံးစက် (...) ကိုနှိပ်ပါ။</li>
                               <li><b>"+ Add connections"</b> ကိုရွေးချယ်ပြီး သင် အဆင့်(၁)တွင် ပြုလုပ်ခဲ့သော Integration ("ZinNotes App") ကိုရှာပြီး ချိတ်ဆက်ပေးလိုက်ပါ။</li>
                           </ol>
                        </div>
                        <p class="font-semibold">အားလုံးပြီးဆုံးပါပြီ။ "Save Notion Settings" ကိုနှိပ်ပြီး စတင်အသုံးပြုနိုင်ပါပြီ။</p>
                    </div>
                </details>

            </div>
            
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.07)] border-t">
        <div class="flex justify-around max-w-4xl mx-auto">
            <button data-page="home-page" class="nav-item flex-1 p-2 text-blue-600">
                <svg class="w-6 h-6 mx-auto" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg>
                <span class="text-xs">Home</span>
            </button>
            <button data-page="notes-page" class="nav-item flex-1 p-2 text-gray-500">
                <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                <span class="text-xs">Notes</span>
            </button>
            <button data-page="history-page" class="nav-item flex-1 p-2 text-gray-500">
                 <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span class="text-xs">History</span>
            </button>
            <button data-page="settings-page" class="nav-item flex-1 p-2 text-gray-500">
                <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span class="text-xs">Settings</span>
            </button>
        </div>
    </nav>

    <!-- Modal Structure -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-md"></div>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE & CONSTANTS ---
            const NOTES_KEY = 'zinnotes_notes';
            const HISTORY_KEY = 'zinnotes_history';
            const GEMINI_API_KEY = 'zinnotes_gemini_api_key';
            const NOTION_API_KEY = 'zinnotes_notion_api_key';
            const NOTION_DATABASE_ID = 'zinnotes_notion_database_id';
            let isRecording = false;
            let mediaRecorder, audioChunks = [], currentEditingNoteId = null, wakeLock = null, timerInterval = null, secondsElapsed = 0;

            // --- DOM ELEMENTS ---
            const pages = document.querySelectorAll('.page');
            const navItems = document.querySelectorAll('.nav-item');
            const micButton = document.getElementById('mic-btn');
            const liveTranscriptionDiv = document.getElementById('live-transcription');
            const notesList = document.getElementById('notes-list');
            const historyList = document.getElementById('history-list');
            const geminiApiKeyInput = document.getElementById('gemini-api-key-input');
            const saveGeminiKeyBtn = document.getElementById('save-gemini-key-btn');
            const notionApiKeyInput = document.getElementById('notion-api-key-input');
            const notionDatabaseIdInput = document.getElementById('notion-database-id-input');
            const saveNotionSettingsBtn = document.getElementById('save-notion-settings-btn');
            const modalContainer = document.getElementById('modal-container');
            const modalContent = document.getElementById('modal-content');
            const timerDisplay = document.getElementById('timer-display');

            // --- UTILITY & MODAL ---
            const getFromStorage = (key) => JSON.parse(localStorage.getItem(key)) || [];
            const saveToStorage = (key, data) => localStorage.setItem(key, JSON.stringify(data));
            const getGeminiApiKey = () => localStorage.getItem(GEMINI_API_KEY);
            const getUserNotionApiKey = () => localStorage.getItem(NOTION_API_KEY);
            const getUserNotionDbId = () => localStorage.getItem(NOTION_DATABASE_ID);

            const showModal = (htmlContent) => {
                modalContent.innerHTML = htmlContent;
                modalContainer.classList.remove('hidden');
            };
            const hideModal = () => {
                modalContainer.classList.add('hidden');
                modalContent.innerHTML = '';
            };
            const showAlert = (message, type = 'info') => {
                const colors = { info: 'blue', success: 'green', error: 'red' };
                showModal(`<div class="p-6 text-center"><p class="text-lg">${message}</p><button class="modal-close mt-4 bg-${colors[type]}-500 text-white px-6 py-2 rounded-md">OK</button></div>`);
            };
            modalContainer.addEventListener('click', (e) => {
                if (e.target === modalContainer || e.target.closest('.modal-close') || e.target.closest('.modal-cancel')) hideModal();
            });

            // --- PAGE NAVIGATION ---
            const showPage = (pageId) => {
                pages.forEach(p => p.classList.add('hidden'));
                document.getElementById(pageId).classList.remove('hidden');
                navItems.forEach(item => {
                    item.classList.toggle('text-blue-600', item.dataset.page === pageId);
                    item.classList.toggle('text-gray-500', item.dataset.page !== pageId);
                });
                if (pageId === 'notes-page') renderNotes();
                if (pageId === 'history-page') renderHistory();
            };
            navItems.forEach(item => item.addEventListener('click', () => showPage(item.dataset.page)));

            // --- SETTINGS ---
            const saveGeminiApiKey = () => {
                const key = geminiApiKeyInput.value.trim();
                if (key && key !== '********') {
                    localStorage.setItem(GEMINI_API_KEY, key);
                    showAlert('Gemini API Key saved successfully!', 'success');
                    geminiApiKeyInput.value = '********';
                } else if (!key) {
                    showAlert('Please enter a valid Gemini API Key.', 'error');
                }
            };
            saveGeminiKeyBtn.addEventListener('click', saveGeminiApiKey);

            const saveUserNotionSettings = () => {
                const apiKey = notionApiKeyInput.value.trim();
                const dbId = notionDatabaseIdInput.value.trim();
                if (apiKey && apiKey !== '********' && dbId) {
                    localStorage.setItem(NOTION_API_KEY, apiKey);
                    localStorage.setItem(NOTION_DATABASE_ID, dbId);
                    showAlert('Notion settings saved successfully!', 'success');
                    notionApiKeyInput.value = '********';
                } else if (!dbId || !apiKey) {
                    showAlert('Please fill in both Notion API Key and Database ID.', 'error');
                } else {
                     showAlert('Notion settings saved successfully!', 'success');
                }
            };
            saveNotionSettingsBtn.addEventListener('click', saveUserNotionSettings);
            
            // --- WAKE LOCK & TIMER ---
            const requestWakeLock = async () => { if ('wakeLock' in navigator) try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) { console.error(`Wake Lock Error: ${err.name}, ${err.message}`); } };
            const releaseWakeLock = async () => { if (wakeLock) try { await wakeLock.release(); wakeLock = null; } catch (err) { console.error(`Wake Lock Release Error: ${err.name}, ${err.message}`); } };
            const startTimer = () => { secondsElapsed = 0; timerDisplay.textContent = '00:00'; timerInterval = setInterval(() => { secondsElapsed++; const minutes = Math.floor(secondsElapsed / 60).toString().padStart(2, '0'); const seconds = (secondsElapsed % 60).toString().padStart(2, '0'); timerDisplay.textContent = `${minutes}:${seconds}`; }, 1000); };
            const stopTimer = () => { clearInterval(timerInterval); timerInterval = null; timerDisplay.textContent = ''; };

            // --- TRANSCRIPTION LOGIC ---
            const transcribeAudioWithGemini = async (audioBlob) => {
                const apiKey = getGeminiApiKey();
                if (!apiKey) {
                    showAlert("Please save your Gemini API Key in Settings.", 'error');
                    return null;
                }
                liveTranscriptionDiv.textContent = 'Transcribing with Gemini...';
                try {
                    const genAI = new window.GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    await new Promise(resolve => reader.onload = resolve);
                    const base64Audio = reader.result.split(',')[1];
                    const audioPart = { inlineData: { data: base64Audio, mimeType: audioBlob.type } };
                    const result = await model.generateContent(["Transcribe this audio from Myanmar (Burmese) language.", audioPart]);
                    return result.response.text();
                } catch (error) {
                    console.error("Error with Gemini API:", error);
                    showAlert(`Error during transcription: ${error.message}`, 'error');
                    return null;
                }
            };
            
            const startRecording = async () => {
                if (!getGeminiApiKey()) {
                    showAlert("Gemini API Key မထည့်သွင်းရသေးပါ။ Settings သို့သွား၍ API Key ထည့်သွင်းပေးပါ။", 'error');
                    return;
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    await requestWakeLock(); 
                    startTimer(); 
                    isRecording = true;
                    micButton.classList.add('bg-red-500', 'pulse-red');
                    micButton.classList.remove('bg-blue-600');
                    liveTranscriptionDiv.textContent = 'Recording...';
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    mediaRecorder.start();
                    mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                    mediaRecorder.onstop = async () => {
                        releaseWakeLock(); 
                        stopTimer(); 
                        stream.getTracks().forEach(track => track.stop());
                        if(audioChunks.length === 0) return;
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const text = await transcribeAudioWithGemini(audioBlob);
                        if (text) {
                            liveTranscriptionDiv.textContent = text;
                            saveNote(text);
                            saveHistory(text);
                            showAlert("Transcription complete and saved!", 'success');
                        } else {
                            liveTranscriptionDiv.textContent = 'Could not transcribe. Please try again.';
                        }
                    };
                } catch (err) {
                    console.error("Microphone error:", err);
                    showAlert("Microphone access was denied or an error occurred.", 'error');
                    releaseWakeLock(); stopTimer();
                }
            };

            const stopRecording = () => {
                if (mediaRecorder && mediaRecorder.state === "recording") {
                    mediaRecorder.stop();
                    isRecording = false;
                    micButton.classList.remove('bg-red-500', 'pulse-red');
                    micButton.classList.add('bg-blue-600');
                }
            };
            micButton.addEventListener('click', () => isRecording ? stopRecording() : startRecording());

            // --- NOTE & HISTORY & NOTION ---
            const saveNote = (content, id = null) => {
                let notes = getFromStorage(NOTES_KEY);
                if (id) {
                    const index = notes.findIndex(n => n.id === id);
                    if (index > -1) {
                        notes[index].content = content;
                        notes[index].title = content.substring(0, 40) + '...';
                    }
                } else {
                    notes.unshift({ id: Date.now(), title: content.substring(0, 40) + '...', content: content, createdAt: new Date().toISOString() });
                }
                saveToStorage(NOTES_KEY, notes);
            };
            
            const saveHistory = (content) => {
                let history = getFromStorage(HISTORY_KEY);
                history.unshift({ id: Date.now(), content: content, createdAt: new Date().toISOString() });
                saveToStorage(HISTORY_KEY, history.slice(0, 50));
            };

            const deleteNote = (id) => {
                let notes = getFromStorage(NOTES_KEY);
                saveToStorage(NOTES_KEY, notes.filter(note => note.id !== id));
                renderNotes();
            };
            
            const saveNoteToNotion = async (content) => {
                const userApiKey = getUserNotionApiKey();
                const userDbId = getUserNotionDbId();

                if (!userApiKey || !userDbId) {
                    showAlert('Please set your Notion API Key and Database ID in Settings first.', 'error');
                    return;
                }
                showModal(`<div class="p-6 text-center"><p class="text-lg">Saving to Notion...</p></div>`);
                try {
                    const proxyUrl = `/.netlify/functions/saveToNotion`;
                    const response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            noteContent: content,
                            notionApiKey: userApiKey,
                            notionDbId: userDbId
                        }),
                    });

                    if (!response.ok) {
                        let errorMsg = `Server responded with status: ${response.status}`;
                        try {
                            const errorData = await response.json();
                            errorMsg = errorData.error || JSON.stringify(errorData);
                        } catch (jsonError) {
                            console.error("Could not parse error response as JSON.", jsonError);
                            errorMsg = `Function not found (404) or another server error occurred. Please check your Netlify deploy logs.`;
                        }
                        throw new Error(errorMsg);
                    }
                    
                    await response.json();
                    showAlert('Successfully saved to Notion!', 'success');
                } catch (error) {
                    console.error('Error during saveNoteToNotion:', error);
                    showAlert(`Failed to save to Notion: ${error.message}`, 'error');
                }
            };
            
            // --- UI RENDERING ---
            const renderNotes = () => {
                notesList.innerHTML = '';
                const notes = getFromStorage(NOTES_KEY);
                if (notes.length === 0) {
                    notesList.innerHTML = '<p class="text-center text-gray-500">No saved notes yet.</p>';
                    return;
                }
                notes.forEach(note => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-md';
                    card.innerHTML = `
                        <p class="text-sm text-gray-800 break-words">${note.content}</p>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-xs text-gray-400">${new Date(note.createdAt).toLocaleString()}</span>
                            <div class="flex items-center gap-2">
                                <button data-action="notion" class="p-2 hover:bg-gray-200 rounded-full" title="Save to Notion">
                                    <svg class="w-4 h-4 text-gray-700" viewBox="0 0 448 512" fill="currentColor"><path d="M252.3 35.7L256 32v224h192V32l-3.2 3.2-35.3 35.3-3.1 3.1-3.2-3.1-35.3-35.3-3.1-3.1-3.2 3.1-35.3 35.3-3.1 3.1-3.2-3.1-35.3-35.3-2.6-2.6zM224 256V32L0 256v224l224-224zm0 248.3l-35.3-35.3-3.1-3.1-3.2 3.1-35.3 35.3-3.1 3.1-3.2-3.1-35.3-35.3-3.1-3.1-3.2 3.1-35.3 35.3-3.2 3.1V288l192 192v-25.3z"/></svg>
                                </button>
                                <button data-action="delete" class="p-2 hover:bg-gray-200 rounded-full" title="Delete"><svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                            </div>
                        </div>
                    `;
                    card.querySelector('[data-action="notion"]').addEventListener('click', (e) => { e.stopPropagation(); saveNoteToNotion(note.content); });
                    card.querySelector('[data-action="delete"]').addEventListener('click', (e) => { e.stopPropagation(); deleteNote(note.id); });
                    notesList.appendChild(card);
                });
            };

            const renderHistory = () => { /* ... unchanged ... */ };
            
            // --- INITIAL LOAD ---
            if (getGeminiApiKey()) geminiApiKeyInput.value = '********';
            if (getUserNotionApiKey()) notionApiKeyInput.value = '********';
            notionDatabaseIdInput.value = getUserNotionDbId() || '';
            showPage('home-page');
        });
    </script>
</body>
</html>

