<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZinNotes - Gemini AI Companion</title>
    <!-- Google AI SDK -->
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>
    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --secondary-color: #34A853; /* Google Green */
            --background-color: #F8F9FA;
            --text-color: #202124;
            --light-text-color: #FFF;
            --card-bg-color: #FFFFFF;
            --border-color: #DADCE0;
            --shadow: 0 1px 3px rgba(60,64,67,0.3 );
        }
        body { font-family: 'Google Sans', Roboto, Arial, sans-serif; margin: 0; background-color: var(--background-color); color: var(--text-color); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .app-container { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }
        .app-header { text-align: center; padding: 10px 20px; border-bottom: 1px solid var(--border-color); }
        .app-header .logo { font-size: 24px; font-weight: bold; color: var(--primary-color); }
        .page { display: none; } /* All pages are hidden by default */
        .page.active { display: block; } /* Only the active page is shown */
        #home-page { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 100%; }
        .instruction-text { font-size: 16px; color: #5f6368; margin-bottom: 30px; }
        .mic-button { width: 120px; height: 120px; border-radius: 50%; background-color: var(--primary-color); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(66, 133, 244, 0.4); transition: all 0.2s ease; }
        .mic-button:hover { transform: scale(1.05); }
        .mic-button.recording { background-color: #EA4335; /* Google Red */ animation: pulse 1.5s infinite; }
        .mic-button svg { width: 50px; height: 50px; fill: var(--light-text-color); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(234, 67, 53, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(234, 67, 53, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 67, 53, 0); } }
        .live-transcription { margin-top: 30px; font-size: 18px; color: #3c4043; min-height: 50px; width: 90%; max-width: 600px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: var(--shadow); }
        .note-list { display: flex; flex-direction: column; gap: 15px; }
        .note-card { background-color: var(--card-bg-color); border-radius: 12px; padding: 15px 20px; box-shadow: var(--shadow); cursor: pointer; transition: transform 0.2s ease; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 65px; background-color: var(--card-bg-color); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.07); border-top: 1px solid var(--border-color); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: #5f6368; transition: color 0.2s ease; flex-grow: 1; height: 100%; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item svg { width: 24px; height: 24px; fill: currentColor; margin-bottom: 4px; }
        .nav-item span { font-size: 12px; }
        #api-key-section { padding: 20px; background: #fff; border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 20px; }
        #api-key-section input { width: 80%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; }
        #api-key-section button { padding: 10px 15px; border: none; background-color: var(--secondary-color); color: white; border-radius: 4px; cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body>
    <header class="app-header"><div class="logo">ZinNotes</div></header>
    
    <main class="app-container">
        <!-- API Key Section - Stays outside the pages -->
        <div id="api-key-section">
            <label for="api-key-input">Your Gemini API Key:</label>
            <input type="password" id="api-key-input" placeholder="Enter your API Key here">
            <button id="save-key-btn">Save</button>
        </div>

        <!-- Page 1: Home (Active by default) -->
        <div id="home-page" class="page active">
            <p class="instruction-text">မှတ်စုမှတ်ရန် အသံပီသစွာပြောပေးပါ</p>
            <button id="mic-btn" class="mic-button"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg></button>
            <div id="live-transcription" class="live-transcription"></div>
        </div>

        <!-- Page 2: Notes (Hidden by default) -->
        <div id="notes-page" class="page">
            <h2>Saved Notes</h2>
            <div id="notes-list" class="note-list">
                <!-- Notes will be dynamically inserted here by JavaScript -->
            </div>
        </div>
    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" data-page="home-page"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg><span>Home</span></div>
        <div class="nav-item" data-page="notes-page"><svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V6h5.17l2 2H20v10z"/></svg><span>Notes</span></div>
    </nav>

    <script type="module">
        document.addEventListener('DOMContentLoaded', async function() {
            // --- DOM ELEMENTS ---
            const pages = document.querySelectorAll('.page');
            const navItems = document.querySelectorAll('.nav-item');
            const micButton = document.getElementById('mic-btn');
            const liveTranscriptionDiv = document.getElementById('live-transcription');
            const notesList = document.getElementById('notes-list');
            const apiKeyInput = document.getElementById('api-key-input');
            const saveKeyBtn = document.getElementById('save-key-btn');

            // --- STATE & CONSTANTS ---
            let isRecording = false;
            let mediaRecorder;
            let audioChunks = [];
            const NOTES_KEY = 'zinnotes_notes';
            const API_KEY = 'gemini_api_key';

            // --- API KEY HANDLING ---
            function saveApiKey() {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem(API_KEY, key);
                    alert('API Key saved successfully!');
                    apiKeyInput.value = '********'; // Mask the key after saving
                } else {
                    alert('Please enter a valid API Key.');
                }
            }

            function getApiKey() {
                return localStorage.getItem(API_KEY);
            }

            saveKeyBtn.addEventListener('click', saveApiKey);
            if (getApiKey()) {
                apiKeyInput.value = '********'; // Show that a key is already saved on load
            }

            // --- PAGE NAVIGATION ---
            function showPage(pageId) {
                // Hide all pages
                pages.forEach(p => p.classList.remove('active'));
                // Show the selected page
                document.getElementById(pageId).classList.add('active');
                
                // Update active state for nav items
                navItems.forEach(item => {
                    item.classList.toggle('active', item.dataset.page === pageId);
                });

                // ** CRITICAL CHANGE HERE **
                // If the notes page is being shown, render the notes.
                if (pageId === 'notes-page') {
                    renderNotes();
                }
            }
            navItems.forEach(item => item.addEventListener('click', () => showPage(item.dataset.page)));

            // --- CORE TRANSCRIPTION LOGIC (GEMINI) ---
            async function transcribeAudioWithGemini(audioBlob) {
                const apiKey = getApiKey();
                if (!apiKey) {
                    alert("Please save your Gemini API Key first.");
                    return null;
                }

                liveTranscriptionDiv.textContent = 'Transcribing with Gemini...';
                const genAI = new window.GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                await new Promise(resolve => reader.onload = resolve);
                const base64Audio = reader.result.split(',')[1];

                const audioPart = {
                    inlineData: { data: base64Audio, mimeType: audioBlob.type },
                };

                try {
                    const result = await model.generateContent(["Transcribe the following audio.", audioPart]);
                    return result.response.text();
                } catch (error) {
                    console.error("Error with Gemini API:", error);
                    alert("Error during transcription. Check the console for details.");
                    return null;
                }
            }

            // --- MEDIA RECORDER LOGIC ---
            async function startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    isRecording = true;
                    micButton.classList.add('recording');
                    liveTranscriptionDiv.textContent = 'Recording...';
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm;codecs=opus' });
                        const text = await transcribeAudioWithGemini(audioBlob);
                        if (text) {
                            liveTranscriptionDiv.textContent = text;
                            saveNote(text);
                            alert("Transcription complete and saved to notes!");
                        } else {
                            liveTranscriptionDiv.textContent = 'Could not transcribe. Please try again.';
                        }
                        stream.getTracks().forEach(track => track.stop());
                    };
                } catch (error) {
                    alert("Microphone access was denied.");
                }
            }

            function stopRecording() {
                if (mediaRecorder && mediaRecorder.state === "recording") {
                    mediaRecorder.stop();
                    isRecording = false;
                    micButton.classList.remove('recording');
                }
            }

            micButton.addEventListener('click', () => {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            });

            // --- LOCALSTORAGE & RENDERING ---
            function getFromStorage(key) { return JSON.parse(localStorage.getItem(key)) || []; }
            function saveToStorage(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

            function saveNote(content) {
                const notes = getFromStorage(NOTES_KEY);
                const newNote = { id: Date.now(), title: content.substring(0, 40) + '...', content: content };
                notes.unshift(newNote);
                saveToStorage(NOTES_KEY, notes);
            }

            function renderNotes() {
                notesList.innerHTML = ''; // Clear previous list
                const notes = getFromStorage(NOTES_KEY);
                if (notes.length === 0) {
                    notesList.innerHTML = '<p>No saved notes yet. Go to the Home tab to record a new note.</p>';
                    return;
                }
                notes.forEach(note => {
                    const card = document.createElement('div');
                    card.className = 'note-card';
                    card.innerHTML = `<h3>${note.title}</h3><p>${note.content}</p>`;
                    card.onclick = () => alert(note.content); // Simple view on click
                    notesList.appendChild(card);
                });
            }

            // --- INITIAL LOAD ---
            // No need to call renderNotes() on initial load anymore.
            // It will be called when the user clicks the "Notes" tab.
        });
    </script>
</body>
</html>
